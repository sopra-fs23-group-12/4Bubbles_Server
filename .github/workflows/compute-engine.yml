name: Build and Deploy to Google Compute Engine

on:
  push:
    branches:
      - google-compute-engine

jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'zulu' # Alternative distribution options are available

      - name: Build JAR file
        run: ./gradlew build
        
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          project_id: sopra-fs23-group-12-server-v2
          service_account_key: ${{ secrets.GCE_SECRET }}
          export_default_credentials: true

      - name: Copy JAR file to Google Compute Engine
        run: |
          gcloud compute scp target/your-app.jar <INSTANCE_NAME>:~/app.jar \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --zone=us-central1-a \
            --ssh-key-file=${{ secrets.GCE_SSH_KEY_PATH }}
